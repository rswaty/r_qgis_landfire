---
title: "terraForMW1"
author: "Randy Swaty"
date: "2022-11-11"
output: html_document
---



## Packages, set name variable (set for each landscape)


```{r libraries, message=FALSE, warning=FALSE, include=FALSE}

library(foreign)
#library(raster)
library(scales)
library(sf)
library(stringr)
library(terra)
library(tidyverse)
library(tools)
library(varhandle)


landscape_name <- "Bitterroot National Forest"
```


## Read in shapefile

```{r read shapefile, message=FALSE, warning=FALSE, include=FALSE}
# Read the shapefile data from "inputs/bitterroot_nf.shp"
shp <- st_read("inputs/bitterroot_nf.shp") %>%
  st_transform(crs = 5070) %>%  # Transform the coordinate reference system (CRS) to EPSG 5070
  st_union() %>%  # Union the geometries within the shapefile
  st_sf()  # Convert the result to a simple features (sf) object

# Display the vector summary of 'shp'
vect(shp)

# Create a plot of the shapefile
plot(shp)
```


## BpS
<br>

### Process spatial data



```{r}

# Load the raster data from the specified file
bps_aoi <- rast("inputs/LF2020_BPS_220_CONUS/LC20_BPS_220.tif") %>%
  # Crop the raster using the shapefile 'shp'
  crop(shp) %>%  
  # Mask the cropped raster with the same shapefile 'shp'
  mask(shp)     

# Read the attribute data from the CSV file
bps_conus_atts <- read.csv("inputs/LF20_BPS_220.csv")

# Set the levels of the first factor in 'bps_aoi' to match the attributes from 'bps_conus_atts'
levels(bps_aoi)[[1]] <- bps_conus_atts

# Set the active category in 'bps_aoi' to "VALUE"
activeCat(bps_aoi) <- "VALUE"


# Retrieve values from 'bps_aoi', excluding missing values (na.rm = TRUE)
bps_aoi_atts <- values(bps_aoi, dataframe = T, na.rm = T) %>%
  # Create a frequency table based on the 'VALUE' column
  table(dnn = "VALUE") %>%
  # Convert the resulting table to a data frame
  as.data.frame() %>%
  # Convert all columns to character type
  mutate_all(as.character) %>%
  # Convert all columns to integer type.
  mutate_all(as.integer) %>%
  # Join the data frame with the categories from 'bps_aoi'
  left_join(cats(bps_aoi)[[1]], by = "VALUE") %>%
  # Remove rows where Freq = 0
  filter(Freq != 0) %>%
  # Calculate acres (ACRES) based on the frequency (Freq) and conversion factor (900 / 4046.86)
  mutate(ACRES = round((Freq * 900 / 4046.86), 0),
  # Compute relative percentage (REL_PERCENT) by dividing the frequency by the total sum of frequencies and multiplying by 100
   REL_PERCENT = round((Freq / sum(Freq)), 3) * 100) %>%
  # Arrange the resulting data frame in descending order of relative percentage
  arrange(desc(REL_PERCENT))


# Write the 'bps_aoi' raster to a GeoTIFF file named "outputs/bps_aoi.tif"
# with specified GDAL options for compression and world file creation.
writeRaster(bps_aoi, "outputs/bps_aoi.tif",
            gdal = c("COMPRESS=NONE", "TFW=YES"),
            datatype = "INT2S",
            overwrite = TRUE)

# Write the attribute table data ('bps_aoi_atts') to a DBF file named "outputs/bps_aoi.tif.vat.dbf"
write.dbf(bps_aoi_atts, "outputs/bps_aoi.tif.vat.dbf")

## write csv for fun
write.csv(bps_aoi_atts, "outputs/bps_aoi_attributes.csv")

# top 10 BpSs for charts, etc.
bpsname10 <- bps_aoi_atts %>%
  # Group the data by 'BPS_NAME'
  group_by(BPS_NAME) %>%
  # Summarize the total acres (ACRES) and relative percentage (REL_PERCENT) within each group
  summarize(ACRES = sum(ACRES),
            REL_PERCENT = sum(REL_PERCENT)) %>%
  # Arrange the results in descending order of relative percentage
  arrange(desc(REL_PERCENT)) %>%
  # Exclude rows where 'BPS_NAME' is "Open Water" or "Barren-Rock/Sand/Clay"
  subset(BPS_NAME != "Open Water" & BPS_NAME != "Barren-Rock/Sand/Clay") %>%
  # Keep only distinct rows for each 'BPS_NAME'
  distinct(BPS_NAME, .keep_all = TRUE) %>%
  # Select the top 10 rows based on relative percentage (wt = REL_PERCENT)
  top_n(n = 10, wt = REL_PERCENT) 
    
    
   
## make color file
 summary_bps_name <- bps_aoi_atts %>%
   subset(BPS_NAME != "Open Water" & BPS_NAME != "Barren-Rock/Sand/Clay") %>%
   group_by(BPS_NAME) %>%
   summarise(bps_name_totals = sum(REL_PERCENT)) %>%
   ungroup()

## if using top 10
 # top_groups <- summary_bps_name %>%
 #   top_n(10, wt = bps_name_totals)

## if using BpSs with amounts > certain percent

top_groups <- summary_bps_name %>%
  filter(bps_name_totals >= 1)

 filtered_bps_name_groups <- bps_aoi_atts %>%
   filter(BPS_NAME %in% top_groups$BPS_NAME)
 



 BpSColorFile <- filtered_bps_name_groups %>%
       add_column(z = 255) %>%
       dplyr::select(
              VALUE,
              R,
              G,
              B,
              z,
              BPS_NAME)  %>%
       arrange(BPS_NAME) 

 # Code to remove geographies from the BpS color file (or other datasets)
  # geographies <- c(
  #               "Boreal ",
  #               "Central Interior and Appalachian ",
  #               "Great Lakes ",
  #               "Laurentian ",
  #               "Laurentian-Acadian ",
  #               "North-Central Interior ")

# BpSColorFile$BPS_NAME <- gsub(paste(geographies, collapse = "|"), "", BpSColorFile$BPS_NAME)
 
# 
write.table(BpSColorFile, file = "outputs/BpSColorFile.txt", sep = ",",
                row.names = FALSE, col.names = FALSE, quote = FALSE)


```


<br>

### Make a chart of BpS data


```{r}

bpsname10 <- bps_aoi_atts %>%
  group_by(BPS_NAME) %>%
  summarize(ACRES = sum(ACRES),
            REL_PERCENT = sum(REL_PERCENT)) %>%
  arrange(desc(REL_PERCENT)) %>%
  top_n(n = 10, wt = REL_PERCENT)

# plot
bps_chart <- 
  ggplot(data = bpsname10, aes(x = BPS_NAME, y = REL_PERCENT)) +
  geom_bar(stat = "identity", fill = "#4a4a48") +
  coord_flip() +
  scale_x_discrete(limits = rev(bpsname10$BPS_NAME)) +
  theme_bw(base_size = 14) +
  labs(
    title = "Top 10 Biophysical Settings",
    subtitle = landscape_name,
    x = "",
    y = "Percent",
    caption = "Represents dominant vegetation systems pre-European colonization. \n Based on LANDFIRE's Biophysical Settings.  Data available at https://www.landfire.gov/viewer. Randy Swaty, Ecologist, rswaty@tnc.org") +
  theme(plot.title.position = "plot", #NEW parameter. Apply for subtitle too.
        plot.caption.position =  "plot",
        panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_blank())
  

bps_chart

# if the plot looks good, save it
# ggsave("outputs/bpsChart.png", width = 12, height = 5)


```

###  Annual disturbances per BpS



```{r}
bps_disturbances <- read.csv("D:/landfire_R_experiment/conus_inputs/bps_transitions.csv")

bps_aoi_disturbances <- left_join(bps_disturbances, bps_aoi_atts, 
                                  by = c("Model_Code" = "BPS_MODEL")) %>%
                                  drop_na(VALUE) %>%
                        mutate(annual_dist_acres = annual_probability*ACRES) %>%
                        select(-c(3, 7:25))

write.csv(bps_aoi_disturbances, "outputs/bps_aoi_disturbances.csv")


```


## Historical Fire Regime Chart

```{r}
# quick filter bps data (to match top 10 of BpSs)
bps_data10 <- bps_aoi_atts %>%
  top_n(n = 10, wt = REL_PERCENT)

annualFire <- bps_data10 %>%
  mutate(annual_fire_acres = ((1/FRI_ALLFIR)*ACRES)) %>%
  filter(BPS_NAME != 'Open Water') %>%
  group_by(BPS_NAME) %>%
  summarize(acres = sum(annual_fire_acres)) %>%
  arrange(desc(acres)) 

# plot
fireChart <- 
  ggplot(data = annualFire, aes(x = BPS_NAME, y = acres)) +
  geom_bar(stat = "identity") +
  labs(
    title = "Cumulative estimates of all fire types prior to pre-European colonization",
    caption = "Data from landfire.gov",
    x = "",
    y = "Acres") +
  scale_x_discrete(limits = rev(annualFire$BPS_NAME),
                   labels = function(x) str_wrap(x, width = 18)) +
  scale_y_continuous(name = 'Acres', labels = comma) +
  coord_flip() +
  theme_bw(base_size = 14) +
  theme(plot.margin = margin(10, 30, 0, 0))

fireChart

# if the plot looks good, save it
# ggsave("outputs/bpsChart.png", width = 12, height = 5)
```




## EVT

### Process spatial data

```{r}


evt_aoi <- rast("inputs/LF2022_EVT_230_CONUS/LC22_EVT_230.tif") %>%
  crop(shp) %>%
  mask(shp)


evt_conus_atts <- read.csv("inputs/LF22_EVT_230.csv")


levels(evt_aoi)[[1]] <- evt_conus_atts
activeCat(evt_aoi) <- "VALUE"


evt_aoi_atts <- values(evt_aoi, dataframe = T, na.rm = T) %>%
  table(dnn = "VALUE") %>%
  as.data.frame() %>%
  mutate_all(as.character) %>%
  mutate_all(as.integer) %>%
  left_join(cats(evt_aoi)[[1]], by = "VALUE") %>%
  filter(Freq != 0) %>%
  mutate(ACRES = round((Freq * 900 / 4046.86), 0),
   REL_PERCENT = round((Freq / sum(Freq)), 3) * 100) 


writeRaster(evt_aoi, "outputs/evt_aoi.tif",
          gdal = c("COMPRESS=NONE", "TFW=YES"),
          datatype = "INT2S",
          overwrite = TRUE)
write.dbf(evt_aoi_atts, "outputs/evt_aoi.tif.vat.dbf")

## write csv for fun
write.csv(evt_aoi_atts, "outputs/evt_aoi_attributes.csv")

    
##  color file for use in QGIS    
 EVTColorFile <- evt_aoi_atts %>%
  subset(EVT_NAME != "Open Water" & EVT_NAME != "Barren-Rock/Sand/Clay") %>%
  top_n(n = 10, wt = REL_PERCENT) %>%
      add_column(z = 255) %>%
      dplyr::select(VALUE,
             R,
             G,
             B,
             z,
             EVT_NAME)
 
 
write.table(EVTColorFile, file = "outputs/EVTColorFile.txt", sep = ",",
                row.names = FALSE, col.names = FALSE, quote = FALSE)   
    




```

### Make a chart of EVT data

```{r}



evtname10 <- evt_aoi_atts %>%
  group_by(EVT_NAME) %>%
  summarize(ACRES = sum(ACRES),
            REL_PERCENT = sum(REL_PERCENT)) %>%
  arrange(desc(REL_PERCENT)) %>%
  top_n(n = 10, wt = REL_PERCENT)

# plot
evt_chart <- 
  ggplot(data = evtname10, aes(x = EVT_NAME, y = REL_PERCENT)) +
  geom_bar(stat = "identity", fill = "#5c5163") +
  coord_flip() +
  scale_x_discrete(limits = rev(evtname10$EVT_NAME)) +
  theme_bw() +
  labs(
    title = "Top 10 Existing Vegetation Types",
    subtitle = landscape_name,
    x = "",
    y = "Percent",
    caption = "Represents dominant vegetation systems as of 2020. \n Based on LANDFIRE's Existing Vegetation Type data.  Data available at https://www.landfire.gov/viewer. Randy Swaty, Ecologist, rswaty@tnc.org") +
  theme(plot.title.position = "plot", #NEW parameter. Apply for subtitle too.
        plot.caption.position =  "plot",
        panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_blank())
  

evt_chart

ggsave("outputs/evtChart.png", width = 12, height = 5)
```


## EVC

### Process spatial data


```{r}
evc_aoi <- rast("inputs/LF2022_EVC_230_CONUS/LC22_EVC_230.tif") %>%
  crop(shp) %>%
  mask(shp)


evc_conus_atts <- read.csv("inputs/LF22_EVC_230.csv")


levels(evc_aoi)[[1]] <- evc_conus_atts
activeCat(evc_aoi) <- "VALUE"


evc_aoi_atts <- values(evc_aoi, dataframe = T, na.rm = T) %>%
  table(dnn = "VALUE") %>%
  as.data.frame() %>%
  mutate_all(as.character) %>%
  mutate_all(as.integer) %>%
  left_join(cats(evc_aoi)[[1]], by = "VALUE") %>%
  filter(Freq != 0) %>%
  mutate(ACRES = round((Freq * 900 / 4046.86), 0),
   REL_PERCENT = round((Freq / sum(Freq)), 3) * 100) 


writeRaster(evc_aoi, "outputs/evc_aoi.tif",
          gdal = c("COMPRESS=NONE", "TFW=YES"),
          datatype = "INT2S",
          overwrite = T)


write.dbf(evc_aoi_atts, "outputs/evc_aoi.tif.vat.dbf")

## EVC color file for use in QGIS
EVCColorFile <- evc_aoi_atts    %>%
      add_column(z = 255)     %>%
      dplyr::select(VALUE,
                    R,
                    G,
                    B,
                    z,
                    CLASSNAMES) 
    
    
write.table(EVCColorFile, file = "outputs/EVCColorFile.txt", sep = ",",
                row.names = FALSE, col.names = FALSE, quote = FALSE)

## write csv for fun
write.csv(evc_aoi_atts, "outputs/evc_aoi_attributes.csv")
```


### Make a chart from EVC data

```{r}



# create "type" column based on conditions
evcname <- evc_aoi_atts %>% mutate(type = if_else(VALUE %in% 11, "Open Water",
                                             if_else(VALUE %in% 12, "Snow / Ice",
                                                     if_else(VALUE %in% c(13:25), "Developed",
                                                             if_else(VALUE %in% 31, "Barren",
                                                                     if_else(VALUE %in% c(60:70), "Agriculture",
                                                                             if_else(VALUE %in% 32, "Quarries",
                                                                                     if_else(VALUE %in% 100, "Sparse Vegetation",
                                                                                             if_else(VALUE %in% c(101:199), "Tree",
                                                                                                     if_else(VALUE %in% c(201:299), "Shrub",
                                                                                                             if_else(VALUE %in% c(301:399), "Herb",
                                                                                                                     "Other")))))))))))

# create reverse substr() function
revSubstr <- function(x, start, stop) {
  x <- strsplit(x, "")
  sapply(x, 
         function(x) paste(rev(rev(x)[start:stop]), collapse = ""), 
         USE.NAMES = FALSE)  }

# create cover column based on 2nd and 3rd to last values of classname
# if "Other" type, make 0
evcname <- evcname %>% mutate(cover = as.numeric(if_else(VALUE > 100,
                                                         revSubstr(evcname$CLASSNAMES, start = 2, stop = 3),
                                                         "0")))

# create bin breaks for grouping
breaks <- seq(0, 100, 10)
# create intervals for grouping and summarize
# also create factor order for "type"
evcgroup <- evcname %>%
  mutate(interval = cut(cover,
                        breaks, 
                        include.lowest = TRUE, 
                        right = T,
                        labels = c("0-9", "10-19", "20-29", "30-39", "40-49", "50-59", "60-69", "70-79", 
                                   "80-89", "90-100")),
         type = factor(type, levels = c("Tree", "Shrub", "Herb", "Open Water", "Snow / Ice", "Developed", "Agriculture", "Sparse Vegetation", "Barren", "Quarries", "Other"))) %>%
  group_by(type, interval) %>%
  summarize(Freq = sum(Freq),
            ACRES = sum(ACRES),
            REL_PERCENT = sum(REL_PERCENT))

# add label and legend names based on condition
evcgroup <- evcgroup %>% mutate(label = if_else(type %in% c("Tree", "Shrub", "Herb"),
                                                paste0(type, " Cover = ", interval, "%"), as.character(type)),
                                legend = if_else(type %in% c("Tree", "Shrub", "Herb", "Open Water"),
                                                 type, as.factor("Other")))

# turn current label order to factors
evclabel.list <- evcgroup$label
evcgroup <- evcgroup %>% mutate(label = fct_rev(factor(label, evclabel.list)))



# create factor level colors for legend (original from Myles)
## cols <- c("Tree" = "#196F3D", "Shrub" = "#229954", "Herb" = "#52BE80", "Open Water" = "#7FB3D5",
##          "Other" = "#808B96")

# join in custom cols column to color bars by specific label

evc_group_cols <- read.csv("inputs/evc_group_cols.csv")

evcgroup <- left_join(evcgroup, evc_group_cols, by = "label")

evcgroup$label <- factor(evcgroup$label, levels = rev(evcgroup$label))

evcgroup <- evcgroup %>%
  filter(REL_PERCENT > 0.01)

# plot
evcChart <-
  ggplot(data = evcgroup, aes(x = label, y = REL_PERCENT, fill = colors)) +
  geom_bar(stat = "identity") +
  labs(
    title = "Existing Vegetation Cover",
    caption = "Data from landfire.gov",
    x = "Amount of landscape",
    y = "Most dominant lifeform") +
  scale_fill_identity() +
  coord_flip() +
  theme_classic(base_size = 12)+
  theme(legend.position = "none") 


evcChart


# save the plot
# ggsave("outputs/evcclass_barplot.png", width = 12, height = 9)
```

## EVH

### Process spatial data

```{r}
evh_aoi <- rast("inputs/LF2022_EVH_230_CONUS/LC22_EVH_230.tif") %>%
  crop(shp) %>%
  mask(shp)


evh_conus_atts <- read.csv("inputs/LF22_EVH_230.csv")


levels(evh_aoi)[[1]] <- evh_conus_atts
activeCat(evh_aoi) <- "VALUE"


evh_aoi_atts <- values(evh_aoi, dataframe = T, na.rm = T) %>%
  table(dnn = "VALUE") %>%
  as.data.frame() %>%
  mutate_all(as.character) %>%
  mutate_all(as.integer) %>%
  left_join(cats(evh_aoi)[[1]], by = "VALUE") %>%
  filter(Freq != 0) %>%
  mutate(ACRES = round((Freq * 900 / 4046.86), 0),
   REL_PERCENT = round((Freq / sum(Freq)), 3) * 100) 


writeRaster(evh_aoi, "outputs/evh_aoi.tif",
          gdal = c("COMPRESS=NONE", "TFW=YES"),
          datatype = "INT2S",
          overwrite = T)


write.dbf(evh_aoi_atts, "outputs/evh_aoi.tif.vat.dbf")

write.csv(evh_aoi_atts, "outputs/evh_aoi_attributes.csv")

EVHColorFile <- evh_aoi_atts    %>%
      add_column(z = 255)     %>%
      dplyr::select(VALUE,
                    R,
                    G,
                    B,
                    z,
                    CLASSNAMES) 
    
    
write.table(EVHColorFile, file = "outputs/EVHColorFile.txt", sep = ",",
                row.names = FALSE, col.names = FALSE, quote = FALSE)

```


### Make a chart from EVH data

```{r}

# create "type" column based on conditions
evhname <- evh_aoi_atts %>% mutate(type = if_else(VALUE %in% 11, "Open Water",
                                             if_else(VALUE %in% 12, "Snow / Ice",
                                                     if_else(VALUE %in% c(13:25), "Developed",
                                                             if_else(VALUE %in% 31, "Barren",
                                                                     if_else(VALUE %in% c(60:70), "Agriculture",
                                                                             if_else(VALUE %in% 32, "Quarries",
                                                                                     if_else(VALUE %in% 100, "Sparse Vegetation",
                                                                                             if_else(VALUE %in% c(101:199), "Tree",
                                                                                                     if_else(VALUE %in% c(201:299), "Shrub",
                                                                                                             if_else(VALUE %in% c(301:399), "Herb",
                                                                                                                     "Other"))))))))))) %>%
  mutate(height_m = if_else(type %in% "Tree", (VALUE -100),
                            if_else(type %in% "Shrub", ((VALUE - 200) / 10),
                                    if_else(type %in% "Herb", ((VALUE - 300) / 10), 0))) %>%
           as.character() %>% as.numeric())

# create bin breaks for grouping
breaks <- c(0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1, 5, 10, 15, 20, 25, 30, 35, 40, 45, 50, 55, 60, 65, 70, 75, 80, 85, 90, 95, 100)

# create intervals for grouping and summarize
# also create factor order for "type"
evhgroup <- evhname %>%
  mutate(interval = cut(height_m,
                        breaks, 
                        include.lowest = TRUE, 
                        right = F,
                        labels = c("0", "0.1-0.2", "0.2-0.3", "0.3-0.4" ,"0.4-0.5", "0.5-0.6", "0.6-0.7", "0.7-0.8", "0.8-0.9", "0.9-1.0", "1-5", "5-10", "10-15", "15-20", "20-25", "25-30", "30-35", "35-40", "40-45", "45-50", "50-55", "55-60", "60-65", "65-70", "70-75", "75-80", "80-85", "85-90", "90-95", "95-100")),
         type = factor(type, levels = c("Tree", "Shrub", "Herb", "Open Water", "Snow / Ice", "Developed", "Agriculture", "Sparse Vegetation", "Barren", "Quarries", "Other"))) %>%
  group_by(type, interval) %>%
  summarise(VALUE = sum(VALUE),
            ACRES = sum(ACRES),
            REL_PERCENT = sum(REL_PERCENT))



# add label and legend names based on condition
evhgroup <- evhgroup %>% mutate(label = if_else(type %in% c("Tree", "Shrub", "Herb"),
                                                paste0(type, " Height = ", interval, " m"), as.character(type)),
                                legend = if_else(type %in% c("Tree", "Shrub", "Herb", "Open Water"),
                                                 type, as.factor("Other")))
# turn current label order to factors
evhlabel.list <- evhgroup$label
evhgroup <- evhgroup %>% mutate(label = fct_rev(factor(label, evhlabel.list)))

# create factor level colors for legend
##cols <- c("Tree" = "#196F3D", "Shrub" = "#229954", "Herb" = "#52BE80", "Open Water" = "#7FB3D5","Other" = "#808B96")

# join in custom cols column to color bars by specific label

evh_group_cols <- read.csv("inputs/evh_group_cols.csv")

evhgroup <- left_join(evhgroup, evh_group_cols, by = "label")

evhgroup$label <- factor(evhgroup$label, levels = rev(evhgroup$label))

evhgroup <- evhgroup %>%
  filter(REL_PERCENT > 0.01)

# plot
evhChart <-
ggplot(data = evhgroup, aes(x = label, y = REL_PERCENT, fill = colors)) +
  geom_bar(stat = "identity") +
  labs(
    title = "Existing Vegetation Height",
    caption = "Data from landfire.gov",
    x = "",
    y = "percent of landscape") +
  scale_fill_identity() +
  coord_flip() +
  theme_classic(base_size = 12)+
  theme(legend.position = "none")

evhChart



# save plot
#ggsave("outputs/evhclass_barplot.png", width = 12, height = 9)


```

## S-Class Raster work, write attributes


```{r sclass spatial, message=FALSE, warning=FALSE, include=FALSE}
# SCLASS

scls_aoi <- rast("inputs/LF2022_SClass_230_CONUS/LC22_SCla_230.tif")%>%
  crop(shp) %>%
  mask(shp)


scls_conus_atts <- read.csv("inputs/LF22_SCla_230.csv")

# scls_aoi <-  scls_conus_r %>%
#   crop(shp) %>%
#   mask(shp)

levels(scls_aoi)[[1]] <- scls_conus_atts
activeCat(scls_aoi) <- "VALUE"


scls_aoi_atts <- values(scls_aoi, dataframe = T, na.rm = T) %>%
  table(dnn = "VALUE") %>%
  as.data.frame() %>%
  mutate_all(as.character) %>%
  mutate_all(as.integer) %>%
  left_join(cats(scls_aoi)[[1]], by = "VALUE") %>%
  filter(Freq != 0) %>%
  mutate(ACRES = round((Freq * 900 / 4046.86), 0),
   REL_PERCENT = round((Freq / sum(Freq)), 3) * 100) 


writeRaster(scls_aoi, "outputs/scls_aoi.tif",
          gdal = c("COMPRESS=NONE", "TFW=YES"),
          datatype = "INT2S",
          overwrite = T)
write.dbf(scls_aoi_atts, "outputs/scls_aoi.tif.vat.dbf")

write.csv(scls_aoi_atts, "outputs/scls_aoi_attributes.csv")

```


## Combine BpS and Sclass

```{r sclass data, message=FALSE, warning=FALSE}
## read in rasters if needed
#bps_aoi <- raster("outputs/bps_aoi.tif")
#scls_aoi <- raster("outputs/scls_aoi.tif")

#bps_aoi_atts <- read.csv("outputs/bps_aoi_attributes.csv")
#scls_aoi_atts <- read.csv("outputs/scls_aoi_attributes.csv")
#bps_conus_atts <- read.csv("inputs/LF2016_BPS_200_CONUS/CSV_Data/LF16_BPS_200.csv")


  # read in and format refcon
## note: in modified ref con extra columns were deleted, NAs replaced by zeros and non reference sclass columns added
ref_con_modified <- read_csv("inputs/ref_con_modified.csv")
bps_names <- read_csv("inputs/bps_model_number_name.csv")

# pivot long


ref_con <- ref_con_modified %>%
  pivot_longer(!Model_Code, names_to = "refLabel", values_to = "refPercent") %>%
  unite(model_label, c("Model_Code", "refLabel"), remove = FALSE) %>%
  left_join(bps_names)

# get list of aoi BpS model numbers

aoi_bps_models <- bps_aoi_atts$BPS_MODEL

#subset ref_con to aoi
aoi_ref_con <- subset(ref_con, Model_Code %in% aoi_bps_models)


# get current conditions
df <- data.frame('bps_aoi' = as.factor(as.matrix(bps_aoi)), 
               'scls_aoi' = as.factor(as.matrix(scls_aoi)))
#####  compare number of rows to total count of landscape


# calculate table
table(df$bps_aoi, df$scls_aoi)

cmbn <- subset(as.data.frame(table(bps_aoi[],scls_aoi[])), Freq != 0)



cmbn$Var2 <- unfactor(cmbn$Var2)
cmbn$Var1 <- unfactor(cmbn$Var1)

#bring in s-class labels
cmbn <- left_join(cmbn, 
                  scls_aoi_atts %>%
                    dplyr::select(1, 3),
                  by = c("Var2" = "VALUE"))

#bring in bps labels
cmbn2 <- left_join(cmbn, 
                  bps_conus_atts %>%
                    dplyr::select(1:4),
                  by = c("Var1" = "VALUE"))

# calculate current sclass percents
cmbn2 <- cmbn2 %>%
  group_by(Var1, BPS_MODEL) %>%
  mutate(total_count = sum(Freq)) %>%
  mutate(currentPercent = as.integer((Freq/total_count)*100)) %>%
  unite(model_label, c("BPS_MODEL", "LABEL"))
  

# historic and current sclass amounts together  NEED TO HAVE ALL SCLASS COMBOS
BPS_SCLS <- dplyr::left_join(cmbn2,
                                 ref_con,
                                 by = "model_label")
# BPS_SCL misses combos where there is a current sclass missing

BPS_SCLS2 <- dplyr::left_join(aoi_ref_con,
                              cmbn2,
                              by = "model_label")



write.csv(BPS_SCLS2, file = "outputs/bpsScls2.csv")


```


##Sclass demo chart

```{r eval=FALSE, include=FALSE}


## wrangle data, get top groups (BpSs)


bps_scls_top <- BPS_SCLS2 %>%
  group_by(Var1) %>%
  mutate(total.count = sum(Freq)) %>%
  ungroup() %>%
  dplyr::filter(dense_rank(desc(total.count)) < 7) %>%
  dplyr::select(c("BpS_Name", "refLabel",  "currentPercent", "refPercent")) %>%
  pivot_longer(
    cols = c(`refPercent`, `currentPercent`), 
    names_to = "refCur", 
    values_to = "Percent"
    )




# order classes
bps_scls_top$refLabel <- factor(bps_scls_3$refLabel, levels= c(
  "Developed",
  "Agriculture",
  "UE",
  "UN",
  "E",
  "D",
  "C",
  "B",
  "A"))




sclasplot <-
  ggplot(bps_scls_top, aes(fill=factor(refCur), y=Percent, x=refLabel)) + 
  geom_col(width = 0.8, position = position_dodge()) +
  coord_flip() +
  facet_grid(. ~BpS) +
  scale_x_discrete(limits = (levels(bps_scls_3$refLabel))) +
  labs(
    title = "Succession Classes past and present",
    subtitle = "Top BpSs selected for illustration. Not all succession classes present in all BpSs",
    caption = "\nData from landfire.gov.",
    x = "",
    y = "Percent")+
  theme_minimal(base_size = 12)+
  theme(plot.caption = element_text(hjust = 0, face= "italic"), #Default is hjust=1
        plot.title.position = "plot", #NEW parameter. Apply for subtitle too.
        plot.caption.position =  "plot") +
  scale_fill_manual(values = c("#3d4740", "#32a852" ), # present (grey), historical (green)
                    name = " ", 
                    labels = c("Present",
                               "Past")) +
  facet_wrap(~BpS_Name, nrow(3),labeller = labeller(BpS_Name = label_wrap_gen())) +
    theme(panel.spacing = unit(.05, "lines"),
        panel.border = element_rect(color = "black", fill = NA, size = 1), 
        strip.background = element_rect(color = "black", size = 1))

sclasplot

ggsave("outputs/sclass_barplot.png", width = 12, height = 9)


```


## BpS to EVT-GROUPED
```{r}
# read bps and evt rasters
bps_r <- raster("outputs/bps_aoi.tif")
evt_r <- raster("outputs/evt_aoi.tif")

# edit the tables a little bit, mainly names
bps_att <- read.csv(file = "outputs/bps_aoi_attributes.csv") %>%
  dplyr::select(VALUE, GROUPVEG, ACRES) %>%
  rename(BPS_ID = VALUE, bps_acres = ACRES) %>%
  mutate(GROUPVEG = paste("BPS ", GROUPVEG))

evt_att <- read.csv(file = "outputs/evt_aoi_attributes.csv") %>%
  dplyr::select(VALUE, EVT_PHYS, ACRES) %>%
  rename(EVT_ID = VALUE, evt_acres = ACRES) %>%
  mutate(EVT_PHYS = paste("EVT ", EVT_PHYS))

# combine rasters
bps2evt <- stack(bps_r, evt_r) %>%
  getValues() %>%
  as.data.frame() %>%
  plyr::count() %>%
  rename(BPS_ID = BPS_MODEL, EVT_ID = EVT_NAME) %>%
  mutate(acres = round((freq * 900 / 4046.8564224))) %>%
  left_join(bps_att) %>%
  left_join(evt_att) %>%
  drop_na()


write.csv(bps2evt, "outputs/bps2evt.csv")

```


## BpS to EVT-not grouped
```{r eval=FALSE, include=FALSE}
# read bps and evt rasters
bps_r <- raster("outputs/bps_aoi.tif")
evt_r <- raster("outputs/evt_aoi.tif")

# edit the tables a little bit, mainly names
bps_att <- read.csv(file = "outputs/bps_aoi_attributes.csv") %>%
  dplyr::select(VALUE, BPS_NAME, ACRES) %>%
  rename(BPS_ID = VALUE, bps_acres = ACRES) %>%
  mutate(BPS_NAME = paste("BPS ", BPS_NAME))

evt_att <- read.csv(file = "outputs/evt_aoi_attributes.csv") %>%
  dplyr::select(VALUE, EVT_NAME, ACRES) %>%
  rename(EVT_ID = VALUE, evt_acres = ACRES) %>%
  mutate(EVT_NAME = paste("EVT ", EVT_NAME))

# combine rasters
bps2evt <- stack(bps_r, evt_r) %>%
  getValues() %>%
  as.data.frame() %>%
  plyr::count() %>%
  rename(BPS_ID = BPS_CODE, EVT_ID = EVT_NAME) %>%
  mutate(acres = round((freq * 900 / 4046.8564224))) %>%
  left_join(bps_att) %>%
  left_join(evt_att) %>%
  drop_na()


write.csv(bps2evt, "outputs/bps2evt-NAMES.csv")

```





